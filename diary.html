<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>쉼;타로</title>
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, width=device-width">
    <meta name="format-detection" content="telephone=no"> <!--숫자를 전화로 자동링크 방지-->
    
    <meta name="apple-mobile-web-app-capable" content="yes"> <!--애플기종의 상단 주소줄 감춤-->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">  <!--아이폰 주소창의 컬러값을 블랙으로 설정-->

    <link rel="stylesheet" href="style.css">
    <!--js-->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

</head>

<body style="background-color: #000000; color: white; margin:0;">
    <div id="diary-container">
        <div class="diary-nav">
            <script> /*오늘날짜*/
                let today = new Date();   

                let month = today.getMonth() + 1;  // 월
                let date = today.getDate();  // 날짜

                var week = new Array('일', '월', '화', '수', '목', '금', '토') //요일 구하기

                document.write(month + '월 ' + date + '일 ' + '(' + week[today.getDay()] + ')' );
            </script>

            <img src="img/icon/icon_writing.png" onclick="new_diary()" style="width: 5vw; float: right;">
            <img src="img/icon/icon_calendar.png" onclick="location.href='calendar.html'" style="width: 5.5vw; float: right; margin-right: 2vw;">
        </div>

        <div class="d-day-title">
            <!--<div class="events-today"></div>-->
        </div>

        <hr style="border: 0.5px solid #6F6F6F; width:60vw; float:left; margin:3vw;">
        <img src="img/icon/diary_img_view.png" style="width:4vw;">
        <img src="img/icon/diary_text_sel.png" style="width:4vw; margin-left:3vw; margin-top:2vw;">
        
    </div>

    <div id="diary-write">
        <script>
            document.write(month + '월 ' + date + '일 ' + '(' + week[today.getDay()] + ')' );
        </script>
        <img src="img/icon/icon_add.png" style="float:right; width:6vw;" onclick="showPopup(true)">
        <div style="margin-top:15vh;">
            <div contentEditable="true" style="outline:none; position: relative; text-align:left;"></div>
            <img src="img/diary_write.png" style="width: 82vw; position:relative;">
            
        </div>

        <button class="btn" onclick="save_new_diary()">
            저장하기
        </button>

        <!-- 카드 선택 팝업 -->
        <div id="popup" class="hide">
            <div class="content">
                저장된 카드
                <div class="keep-card-list">
            </div>
        </div>
    </div>

    <footer class="footer" style="bottom:0;">
        <img src='img/icon/icon_menu_diary_sel.png' onclick="location.href='diary.html'" class="icon">
        <img src='img/icon/icon_menu_tag.png' onclick="location.href='keep.html'" class="icon">
        <img src='img/icon/icon_menu_main.png' onclick="location.href='home.html'" class="icon">
        <img src='img/icon/icon_menu_meditate.png' onclick="location.href='meditation.html'" class="icon">
        <img src='img/icon/icon_menu_setting.png' onclick="location.href=''" class="icon">
    </footer>



    <script>
    $(function(){
        let storedEvents = JSON.parse(localStorage.getItem('events'));
    
        /* 로컬스토리지에 디데이 데이터가 없을 경우 */
        if (storedEvents == null){
            $('.d-day-title').html('<a>캘린더에서 D-Day를 설정해보세요</a>');
        }
        /* 디데이 데이터가 있을 경우 다 받아오기 */
        else{
            let eventsList = Object.keys(storedEvents).map(k => storedEvents[k]);
            if(eventsList.length>0){
                let eventsLi ='';

                /* 첫 번째 디데이만 가져옴 */
                eventsList.filter(event =>  $('.d-day-title').html(`
                    <img src="img/icon/icon_add.png" onclick="location.href='d-day.html'" style="float:right; width:9vw;">
                    <div class="d-day-title-view">
                        ${event.eventText}
                        D - ${ Math.ceil( (new Date(parseInt(event.eventDate.substr(4,8)), parseInt(event.eventDate.substr(2,2)), parseInt(event.eventDate.substr(0,2))).getTime()-new Date().getTime() ) /(1000 * 60 * 60 * 24) ) }

                        <br>
                        <span class="d-day-message">좀 더 여유로운 마음을 가져도 좋을 것 같아요.</span>
                        </div>
                `));
            }
            else{
                $('.d-day-title').html('<a>캘린더에서 D-Day를 설정해보세요</a>');
            }
        }
    })

    /* 다이어리 추가 */
    function new_diary() {
        document.getElementById("diary-container").style.display = "none";
        document.getElementById("diary-write").style.display = "block";
        $('footer').css('display','none');
        $('body').css('background-color','white');

    }

    /* 다이어리 추가 - 카드 선택 팝업 */
    function showPopup(hasFilter) {
	    const popup = document.querySelector('#popup');
  
        if (hasFilter) {
  	        popup.classList.add('has-filter');
        } else {
  	        popup.classList.remove('has-filter');
        }
  
        popup.classList.remove('hide');
    }

    /* 킵한 카드 리스트 가져오기 */
    $(function(){
        let storedkeeps = JSON.parse(localStorage.getItem('keeplist'));
        $.getJSON("test-data.json", function(json) {

            var cards = json

            /* 로컬스토리지에 디데이 데이터가 없을 경우 */
            if (storedkeeps == null){
                $('.keep-card-list').html('<a style="line-height:60vh; t">keep한 카드가 없습니다.</a>');
            }
            /* 디데이 데이터가 있을 경우 다 받아오기 */
            else{
                let keepLists = Object.keys(storedkeeps).map(k => storedkeeps[k]);
                if(keepLists.length>0){
                    let keepLi ='';

                    keepLists.forEach(keep =>  $('.keep-card-list').html(keepLi +=`
                
                    <img src="${cards[keep.id-1].illust}" id="${cards[keep.id-1].id}" class="keep-img" onClick="select_card_img(${cards[keep.id-1].id})" >

                    `));
                    
                }
                else{
                    $('.keep-card-list').html('<a style="line-height:60vh;">keep한 카드가 없습니다.</a>>');
                }
            }


        });

    
    });


    function select_card_img(id) {
        var selected_card = id;
        console.log(selected_card);
        
        const popup = document.querySelector('#popup');
        popup.classList.add('hide');
    }

    function save_new_diary() {

        /*
        var card_id = document.getElementById("").name;
        var diary_text = document.getElementById("context").innerHTML

        var existingdiary = JSON.parse(localStorage.getItem("diary"));

        if(existingdiary == null) {
            existingdiary = [];
        }

        var entry = {
            "id": card_id,
            "text": diary_text
        };
    
        localStorage.setItem("diary", JSON.stringify(entry));
        // Save allEntries back to local storage
        existingdiary.push(entry);
        localStorage.setItem("diary", JSON.stringify(existingdiary));
        */
    }


    </script>
</body>