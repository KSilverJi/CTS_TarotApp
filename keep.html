<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>쉼;타로</title>
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, width=device-width">
    <meta name="format-detection" content="telephone=no"> <!--숫자를 전화로 자동링크 방지-->
    
    <meta name="apple-mobile-web-app-capable" content="yes"> <!--애플기종의 상단 주소줄 감춤-->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">  <!--아이폰 주소창의 컬러값을 블랙으로 설정-->

    <link rel="stylesheet" href="style.css">
    <!--js-->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="slick/slick.min.js"></script>

</head>

<body style="background-color: black; margin:0;">
<div id="keep-container">
    <div style="margin:8vw;">
        <div style="text-align: center;">
            <p style="font-weight: bold; font-size: 4vw;">Keep</p>
        </div>

        <div class="tag-list">
            <div class="normal-tag default-tag" id="test-tag">시험</div>
            <div class="normal-tag" id="interview-tag">면접</div>
            <div class="normal-tag" id="course-tag">진로</div>
            <div class="normal-tag" id="devi-tag">일탈</div>
            <div class="normal-tag" id="study-tag">공부</div>
            <div class="normal-tag" id="added_tags"></div>
            <div style="display: inline-block;">
                <img src="img/icon/icon_add.png" style="width:8vw; vertical-align:middle;" onclick="add_new_tag()">
            </div>
        </div>

        <div class="keep-card-list">

        </div>
    </div>
</div>

    <!--결과화면-->
    <div id="keep-detail">
        <div class="result-nav">
            <img src="img/icon/icon_X.png" onclick="history.go(0)" style="width:4vw;">
            <img src="img/icon/icon_share.png" style="width:3vw; float:right;">
            <img src="img/icon/icon_tag_black_sel.png" id="keep-btn" onclick="not_likeit_popup(true)">
        </div>
        <div class="card">
            <h2>화연님이 뽑으신 타로는</h2> <a class="card-id" name=""></a>
            <h2 class="cardname"></h2>
            <h2>카드입니다.</h2>
            <img src="" class="card-illust">
            <br><img src="img/icon/icon_menu_main_black.png" style="width:10vw; margin:5vw;">
            <h2 style="color: #000000;">- 타로 결과 -</h2>
		    <h2 class="keyword" style="font-weight:bold;"></h2>
		    <h2 class="keep-analysis"></h2>
		    <table style="text-align:left;">
                <tr>
                    <td style="width:30vw;"><h2 style="text-align:left;">행운의 숫자</h2>
                    <td><h2 class="keep-luckynum"></h2>
                </tr>
                <tr>
                    <td style="width:30vw;"><h2 style="text-align:left;">행운의 색깔</h2>
                    <td><h2 class="keep-luckycolor"></h2>
                </tr>
                <tr>
                    <td style="width:30vw;"><h2 style="text-align:left;">행운의 시간</h2></td>
                    <td><h2 class="keep-luckytime"></h2></td>
                </tr>
            </table>

            <button class="btn" onclick="location.href='diary.html'">
                다이어리 작성하기
            </button>
            <button class="btn" onclick="location.href='meditation.html'">
                명상하기
            </button>
            <br><img src="img/icon/icon_menu_main_black.png" style="width:10vw; margin:5vw;">
        </div>
    </div>

    <!-- 좋아요 취소 시 팝업 -->
    <div id="popup" class="hide">
        <div class="end_meditation" >
            <img src="img/icon/icon_menu_main_sel.png" style="width: 9vw; margin:4vw;"><br>
            하트를 해제하면<br>모든 태그에서 사라집니다.<br><br>
            <img src="img/icon/취소버튼.png" onclick="history.go(0)" style="width:30vw; margin:1vh 3vw 3vh auto;">
            <img src="img/icon/확인버튼.png" onclick="not_likeit()" style="width:30vw; margin-bottom:3vh;">
        </div>
    </div>

    <footer class="footer" style="bottom:0;">
        <img src='img/icon/icon_menu_diary.png' onclick="location.href='diary.html'" class="icon">
        <img src='img/icon/icon_menu_tag_sel.png' onclick="location.href='keep.html'" class="icon">
        <img src='img/icon/icon_menu_main.png' onclick="location.href='home.html'" class="icon">
        <img src='img/icon/icon_menu_meditate.png' onclick="location.href='meditation.html'" class="icon">
        <img src='img/icon/icon_menu_setting.png' onclick="location.href='setting.html'" class="icon">
    </footer>

<div id="add_tag_page" style="display:none;">
    <h1 onclick="location.href='keep.html'" style="color:white; position: absolute; font-size:4vw; top:0; margin-top:6vh;">X</h1>
    <div class="input-group-append" style="position:absolute; top:0; margin-top:6vh; right:10%;">
        <h2>완료</h2>
    </div>
    <p style="font-weight:bold; margin-top:6vh;">태그 만들기</p>
    <div style="margin:8vw; margin-top:8vh;">
        <p style="text-align:left; font-size:3vw;">폴더 이름</p>
        <input type="text" id="folder-input">
        </input>
        <p style="text-align:left; font-size:3vw; margin-top:8vw;">카드 추가</p>
        <img src="img/icon/icon_add.png" style="width:8vw;" onclick="add_tag_card()">
    </div>
</div>

<div id="add_tag_card_page" style="display:none;">
    <form>
        <h1 onclick="history.go(0)" style="color:white; position: absolute; font-size:4vw; top:0; margin-top:6vh;">X</h1>
        <div class="input-group-append" style="position:absolute; top:0; margin-top:6vh; right:10%;">
            <h2 onclick="select_tag_cards()">완료</h2>
        </div>
        <p style="font-weight:bold; margin-top:6vh;">카드 추가</p>
        <div class="stored_card"></div>
    </form>
</div>


    <script>
    $(function(){

        /* 태그 리스트 슬라이더 */
        $('.tag-list').slick({
            infinite: false,
            slidesToShow: 3,
            slidesToScroll: 1,
            arrows : false,
        });

        /* 로컬스토리지에서 데이터 받아오기 */
        let storedkeeps = JSON.parse(localStorage.getItem('keeplist'));
        let storedtags = JSON.parse(localStorage.getItem('taglist'));

        /* 사용자 태그가 있으면 불러오고, 없으면 없음 */
        if (storedtags == null){
            $('#added_tags').removeClass("normal-tag");
        }
        else {
            document.getElementById("added_tags").innerHTML = storedtags[0].tag;
            document.getElementById("added_tags").style.display = "inline-block";
        }

        $.getJSON("test-data.json", function(json) {

            var cards = json

            /* 로컬스토리지에 킵한 카드 데이터가 없을 경우 */
            if (storedkeeps == null){
                $('.keep-card-list').html('<a style="line-height:60vh; ">keep한 카드가 없습니다.</a>');
            }
            /* 데이터가 있을 경우 다 받아오기 */
            else{
                /* 기본 값 : 시험 태그 */
                /* 전체(all) 킵리스트에서 특정 id 범위 내 카드 지정 */
                let keepLists_all = Object.keys(storedkeeps).map(k => storedkeeps[k]);
                keepLists = keepLists_all.filter(x => {return x.id <= 22});
                if(keepLists.length>0){
                    
                    let keepLi ='';

                    keepLists.forEach(keep =>  $('.keep-card-list').html(keepLi +=`
                
                    <img src="${cards[keep.id-1].illust}" class="keep-img" onClick="keep_detail(${keep.id})" >

                    `));
                }

                else{
                    $('.keep-card-list').html('<a style="line-height:60vh;">keep한 카드가 없습니다.</a>');
                }

                $('#test-tag').click(function(){
                    $('.default-tag').removeClass("default-tag");
                    $('#test-tag').addClass("default-tag");

                    if(keepLists.length>0){
                        keepLists = keepLists_all.filter(x => {return x.id <= 22});
                        let keepLi ='';

                        keepLists.forEach(keep =>  $('.keep-card-list').html(keepLi +=`
                
                        <img src="${cards[keep.id-1].illust}" class="keep-img" onClick="keep_detail(${keep.id})" >

                        `));
                    }
                    else{
                        $('.keep-card-list').html('<a style="line-height:60vh;">keep한 카드가 없습니다.</a>');
                    }
                })

                
                $('#interview-tag').click(function(){
                    /* 태그 누르면 색 변경 */
                    $('.default-tag').removeClass("default-tag");
                    $('#interview-tag').addClass("default-tag");

                    if(keepLists.length>0){
                        keepLists = keepLists_all.filter(x => {return x.id > 22 && x.id <=44});
                        let keepLi ='';

                        keepLists.forEach(keep =>  $('.keep-card-list').html(keepLi +=`
                
                        <img src="${cards[keep.id-1].illust}" class="keep-img" onClick="keep_detail(${keep.id})" >

                        `));
                    }
                    else{
                        $('.keep-card-list').html('<a style="line-height:60vh;">keep한 카드가 없습니다.</a>');
                    }
                })

                $('#course-tag').click(function(){
                    $('.default-tag').removeClass("default-tag");
                    $('#course-tag').addClass("default-tag");
                    
                    if(keepLists.length>0){
                        keepLists = keepLists_all.filter(x => {return x.id > 44 && x.id <= 66});
                        let keepLi ='';

                        keepLists.forEach(keep =>  $('.keep-card-list').html(keepLi +=`
                
                        <img src="${cards[keep.id-1].illust}" class="keep-img" onClick="keep_detail(${keep.id})" >

                        `));
                    }
                    else{
                        $('.keep-card-list').html('<a style="line-height:60vh;">keep한 카드가 없습니다.</a>');
                    }
                })

                $('#devi-tag').click(function(){
                    $('.default-tag').removeClass("default-tag");
                    $('#devi-tag').addClass("default-tag");

                    if(keepLists.length>0){
                        keepLists = keepLists_all.filter(x => {return x.id > 66 && x.id <=88});
                        let keepLi ='';

                        keepLists.forEach(keep =>  $('.keep-card-list').html(keepLi +=`
                
                        <img src="${cards[keep.id-1].illust}" class="keep-img" onClick="keep_detail(${keep.id})" >

                        `));
                    }
                    else{
                        $('.keep-card-list').html('<a style="line-height:60vh;">keep한 카드가 없습니다.</a>');
                    }
                })

                $('#study-tag').click(function(){
                    $('.default-tag').removeClass("default-tag");
                    $('#study-tag').addClass("default-tag");

                    if(keepLists.length>0){
                        keepLists = keepLists_all.filter(x => {return x.id > 88 && x.id <= 110});
                        let keepLi ='';

                        keepLists.forEach(keep =>  $('.keep-card-list').html(keepLi +=`
                
                        <img src="${cards[keep.id-1].illust}" class="keep-img" onClick="keep_detail(${keep.id})" >

                        `));
                    }
                    else{
                        $('.keep-card-list').html('<a style="line-height:60vh;">keep한 카드가 없습니다.</a>');
                    }
                })

                /* 사용자 지정 태그 데이터 받아와서 출력하기 */
                let tagLists_all = Object.keys(storedtags).map(k => storedtags[k]);

                let tagLists = tagLists_all[0].tag_cards;

                /* 태그는 최대 2개까지 */
                $('#added_tags').click(function(){
                    $('.default-tag').removeClass("default-tag");
                    $('#added_tags').addClass("default-tag");

                    if(tagLists_all.length > 0){
                        let tagLi ='';
                            
                        tagLists.forEach(folder => $('.keep-card-list').html(tagLi +=`
                
                        <img src="${cards[folder-1].illust}" class="keep-img" onClick="keep_detail(${cards[folder-1].id})" >

                        `));
                    }
                    else{
                        $('.keep-card-list').html('<a style="line-height:60vh;">keep한 카드가 없습니다.</a>');
                    }
                    
                })
                
            }


        });
    
    });

    /* 카드 클릭했을 때 자세히 보기 */
    function keep_detail(id) {

        document.getElementById("keep-container").style.display = "none";
        document.getElementById("keep-detail").style.display = "block";
        $('footer').css('display','none');

        let storedkeeps = JSON.parse(localStorage.getItem('keeplist'));

        $.getJSON("test-data.json", function(json) {
            document.getElementsByClassName('card-id')[0].name = json[id-1].id;
            document.getElementsByClassName('cardname')[0].innerHTML = json[id-1].cardname;
            document.getElementsByClassName('card-illust')[0].src = json[id-1].illust;
            document.getElementsByClassName('keyword')[0].innerHTML = json[id-1].keyword;
            document.getElementsByClassName('keep-analysis')[0].innerHTML = json[id-1].analysis;
            document.getElementsByClassName('keep-luckynum')[0].innerHTML = json[id-1].luckynum;
            document.getElementsByClassName('keep-luckycolor')[0].innerHTML = json[id-1].luckycolor;
            var split_time = json[id-1].luckytime.split(':');
            document.getElementsByClassName('keep-luckytime')[0].innerHTML = split_time[0] + '시 ' + split_time[1] + '분';
            })
    }

    /* 하트 취소 */
    function not_likeit_popup(hasFilter) {
        const popup = document.querySelector('#popup');
  
        if (hasFilter) {
  	        popup.classList.add('has-filter');
        } else {
  	        popup.classList.remove('has-filter');
        }
  
        popup.classList.remove('hide');
    }

    function not_likeit() {
        document.getElementById("keep-btn").src = "img/icon/icon_tag_black.png";

        var card_id = document.getElementsByClassName('card-id')[0].name;

        var existingkeep = JSON.parse(localStorage.getItem("keeplist"));
        if(existingkeep == null) {
            existingkeep = [];
        }

        var index_of_keep = existingkeep.findIndex(i => i.id == card_id);
    
        existingkeep.splice(index_of_keep,1); /* 선택한 카드의 인덱스값에서 1개를 제거 */
        localStorage.setItem("keeplist", JSON.stringify(existingkeep));

        /* 태그된 폴더에서도 제거 */
        var existingtag = JSON.parse(localStorage.getItem("taglist"));
        if(existingtag == null) {
            existingtag = [];
        }
        var target = existingtag[0].tag_cards;
        var index_of_tag = target.findIndex(i => i == card_id);
        if (index_of_tag >= 0) { /* 기본 폴더와 사용자 생성 폴더에 이 카드가 동시에 존재한다면 */
            target.splice(index_of_tag,1); /* 선택한 카드의 인덱스값에서 1개를 제거 */
            existingtag[0].tag_cards = target;
            localStorage.setItem("taglist", JSON.stringify(existingtag));
        }
    }


    /* 태그 만들기 */
    function add_new_tag() {
        document.getElementById("keep-container").style.display = "none";
        document.getElementById("add_tag_page").style.display = "block";
        $('footer').css('display','none');

        let storedkeeps = JSON.parse(localStorage.getItem('keeplist'));
    }

    function add_tag_card() {
        document.getElementById("add_tag_page").style.display = "none";
        document.getElementById("add_tag_card_page").style.display = "block";

        let storedkeeps = JSON.parse(localStorage.getItem('keeplist'));
        $.getJSON("test-data.json", function(json) {

            var cards = json

            /* 로컬스토리지에 보관한 데이터가 없을 경우 */
            if (storedkeeps == null){
                $('.stored_card').html('<a style="line-height:60vh; t">keep한 카드가 없습니다.</a>');
            }
            /* 데이터가 있을 경우 다 받아오기 */
            else{
                let keepLists = Object.keys(storedkeeps).map(k => storedkeeps[k]);
                if(keepLists.length>0){
                    let keepLi ='';

                    keepLists.forEach(keep =>  $('.stored_card').html(keepLi +=`
                    
                    <input type="checkbox" id="${cards[keep.id-1].id}" name="keep_check" value="${cards[keep.id-1].id}">
                        <label for="${cards[keep.id-1].id}"></label>
                    <img src="${cards[keep.id-1].illust}" class="keep-img">

                    `));
                    
                }
                else{
                    $('.stored_card').html('<a style="line-height:60vh;">keep한 카드가 없습니다.</a>>');
                }
            }


        });
    }

    /* 카드 선택한 거 받아와서 폴더 이름, 카드 저장 */
    function select_tag_cards() {
        var check_count = document.getElementsByName("keep_check").length;

        checklist = [];
 
        for (var i=0; i < check_count; i++) {
            if (document.getElementsByName("keep_check")[i].checked == true) {
                checklist.push(document.getElementsByName("keep_check")[i].value);
            }
        }

        var folder_name = document.getElementById("folder-input").value;
        var entry = {
            tag : folder_name,
            tag_cards : checklist,
        };

        /* 로컬스토리지에 새 태그 저장 */

        var existingtag = JSON.parse(localStorage.getItem("taglist"));
        if(existingtag == null) {
            existingtag = [];
        }

        localStorage.setItem("tag", JSON.stringify(entry));
        existingtag.push(entry);
        localStorage.setItem("taglist", JSON.stringify(existingtag));

        location.reload();
    }

    </script>

</body>